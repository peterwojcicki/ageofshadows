<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>Babylon.js sample code</title>

    <!-- Babylon.js -->
    <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="js/lib/babylon.objFileLoader.js"></script>
    <script src="js/lib/treegenerator.js"></script>

    <script src="js/player.js"></script>
    <script src="js/skybox.js"></script>
    <script src="js/sound.js"></script>
    <script src="js/water.js"></script>
    <script src="js/fog.js"></script>
    <script src="js/ground.js"></script>
    <script src="js/modelmanager.js"></script>
    <script src="js/modelconfigs.js"></script>
    <script src="js/kelp.js"></script>
    <script src="js/boulder.js"></script>
    <script src="js/kelpmanager.js"></script>
    <script src="js/bouldermanager.js"></script>
    <script src="js/groundscanner.js"></script>
    <script src="js/tree.js"></script>
    <script src="js/treemanager.js"></script>
    <script src="js/bush.js"></script>
    <script src="js/bushmanager.js"></script>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #fps {
            position: absolute;
            background-color: black;
            border: 2px solid red;
            text-align: center;
            font-size: 16px;
            color: white;
            top: 15px;
            right: 10px;
            width: 60px;
            height: 20px;
        }
    </style>
</head>
<body>
<div id="fps">0</div>
<canvas id="renderCanvas"></canvas>
<script>
    var canvas = document.getElementById("renderCanvas");

    var keys = {
        rotateLeft: 0,
        rotateRight: 0,
        left: 0,
        right: 0,
        forward: 0,
        backward: 0,
        zoomIn: 0,
        zoomOut: 0,
        up: 0,
        kick: 0,
        fireGun: 0
    };

    var engine = null;
    var scene = null;
    var camera = null;
    var sceneToRender = null;
    var ground = null;
    var water = null;
    var player = null;
    var fog = null;
    var treeManager;
    var kelpManager;
    var boulderManager;
    var bushManager;

    var createDefaultEngine = function () {
        return new BABYLON.Engine(canvas, true, {
            preserveDrawingBuffer: true,
            stencil: true,
            disableWebGL2Support: false
        });
    };
    var createScene = function () {

        var scene = new BABYLON.Scene(engine);

        /********** POINTER LOCK **************************/
        var isLocked = false;
        scene.onPointerDown = function (evt) {
            if (!isLocked) {
                canvas.requestPointerLock = canvas.requestPointerLock || canvas.msRequestPointerLock || canvas.mozRequestPointerLock || canvas.webkitRequestPointerLock;
                if (canvas.requestPointerLock) {
                    canvas.requestPointerLock();
                }
            }

            evt.preventDefault()
        };

        // Event listener when the pointerlock is updated (or removed by pressing ESC for example).
        var pointerlockchange = function () {
            var controlEnabled = document.mozPointerLockElement || document.webkitPointerLockElement || document.msPointerLockElement || document.pointerLockElement || null;

            // If the user is already locked
            if (!controlEnabled) {
                isLocked = false;
            } else {
                isLocked = true;
            }
        };

        /**************************************************************/

        // Attach events to the document
        document.addEventListener("pointerlockchange", pointerlockchange, false);
        document.addEventListener("mspointerlockchange", pointerlockchange, false);
        document.addEventListener("mozpointerlockchange", pointerlockchange, false);
        document.addEventListener("webkitpointerlockchange", pointerlockchange, false);


        //Adding a light
        new BABYLON.DirectionalLight("Omni", new BABYLON.Vector3(-2, -5, 2), scene);
        new BABYLON.PointLight("Omni2", new BABYLON.Vector3(2, -5, -2), scene);

        player = new Player(scene);

        camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 300, 50), scene);
        camera.attachControl(canvas, true);
        camera.angularsensibility *= -0.3;
        camera.speed = 10;
//        camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
        // TODO this is a hack - making the camera's elipsoid very thin prevents sliding down slopes
        camera.ellipsoid = new BABYLON.Vector3(0.01, 1, 0.01);
        camera.minZ = 0.01;
        camera.checkCollisions = true;
        camera.applyGravity = true;


        scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
        scene.collisionsEnabled = true;
        scene.registerBeforeRender(function () {
            if (keys.up == 1) {
                player.moveUp(camera);
            }
        });

        fog = new Fog();
        fog.enableLandFog(scene);

        var onGroundReady = function (groundMesh) {

            setTimeout(function () {
                groundMesh.updateCoordinateHeights();

                var modelConfig = new ModelConfig();
                var modelConfigs = [];

//                var bambooModelConfigs = {
//                    config: modelConfig.getBambooDefinition(),
//                    instances: []
//                };
//                // TODO
//                for (var x = -4000; x < 4000; x += 10000) {
//                    for (var z = -4000; z < 4000; z += 10000) {
//
//                        var y = groundMesh.getHeightAtCoordinates(x, z);
//                        if (y < 400 && y > 100) {
//                            bambooModelConfigs.instances.push({
//                                position: new BABYLON.Vector3(x, y, z),
//                                rotationY: 0
//                            });
//                        }
//                    }
//                }
//                modelConfigs.push(bambooModelConfigs);

                var modelManager = new ModelManager(modelConfigs, scene);

                kelpManager = new KelpManager(scene);
                boulderManager = new BoulderManager(scene);
                bushManager = new BushManager(scene);
                treeManager = new TreeManager();

                new GroundScanner(scene, ground, water, kelpManager, boulderManager, treeManager, bushManager);
            });
        }

        ground = new Ground(scene, onGroundReady);
        water = new Water(scene, ground.getGround());

        new Skybox(scene);
        new Sound(scene, "sounds/medieval.wav", true);

        return scene;
    }
    var engine;
    var scene;
    var postProcess2;
    var postProcess3;

    initFunction = function () {
        var asyncEngineCreation = function () {
            try {
                return createDefaultEngine();
            } catch (e) {
                console.log("the available createEngine function failed. Creating the default engine instead");
                return createDefaultEngine();
            }
        }

        engine = asyncEngineCreation();
        if (!engine) throw 'engine should not be null.';
        scene = createScene();
    };
    initFunction();


    window.addEventListener('keydown', function (event) {
        window.console.log("Position: " + camera.position + ", ground height: " + ground.getHeightAtCoordinates(camera.position.x, camera.position.z));
        if (event.keyCode == 32) {
            keys.up = 1;
        }
    });
    window.addEventListener('keyup', function (event) {
        if (event.keyCode == 32) {
            keys.up = 0;

            // this is a hack for the camera not falling
            camera._needMoveForGravity = true;
        }
    });


    sceneToRender = scene;

    let frameIndex = 0;
    engine.runRenderLoop(function () {

        let divFps = document.getElementById("fps");

        if (sceneToRender && sceneToRender.activeCamera) {
            divFps.innerHTML = engine.getFps().toFixed() + " fps";
            sceneToRender.render();

            frameIndex++;

            let distanceFromWater = Math.abs(camera.position.y - water.getPosition().y);

            if (water && player && (distanceFromWater < 50) && (frameIndex % 10 == 0)) {
                if (water.isUnderwater(camera)) {
                    if (!player.isUnderwater()) {
                        fog.enableUnderwaterFog(scene);
                        player.goUnderwater();
                        new Sound(scene, "sounds/splash.wav", false);
                        camera.applyGravity = false;
                    }
                } else {
                    if (player.isUnderwater()) {
                        fog.enableLandFog(scene);
                        player.emergeFromUnderwater();
                        camera.applyGravity = true;
                    }
                }
            }

            if (treeManager && frameIndex % 1000) {
                boulderManager.update(camera);
                bushManager.update(camera);
                treeManager.update(scene, camera);
                kelpManager.update(camera, water);
            }
        }
    });

    // distance between 2 points on a horizontal plane
    window.distance = function (vector1, vector2) {
        return Math.sqrt((vector1.x - vector2.x) * (vector1.x - vector2.x) + (vector1.z - vector2.z) * (vector1.z - vector2.z))
    }

    // Resize
    window.addEventListener("resize", function () {
        engine.resize();
    });
</script>
</body>
</html>
